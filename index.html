<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pixel World 2.0 - Mobil Destekli</title>
<style>
  body { margin: 0; background: #0b0b0b; color: #fff; font-family: Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
  header { padding: 10px; text-align: center; background: #111; z-index: 10; font-weight: bold; border-bottom: 1px solid #333; font-size: 14px; }
  #palette { display: flex; gap: 8px; padding: 10px; overflow-x: auto; background: #111; z-index: 10; border-bottom: 1px solid #222; }
  .color { width: 35px; height: 35px; border-radius: 8px; border: 2px solid #333; cursor: pointer; flex-shrink: 0; }
  .color.active { border-color: #fff; transform: scale(1.1); box-shadow: 0 0 10px rgba(255,255,255,0.3); }
  #wrap { flex: 1; position: relative; overflow: hidden; cursor: crosshair; background: #050505; }
  canvas { image-rendering: pixelated; touch-action: none; }
  #ui { position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 8px; font-size: 12px; pointer-events: none; border: 1px solid #444; }
</style>
</head>
<body>

<header>Kaydır: Parmak/Sağ Tık | Zoom: İki Parmak/Tekerlek</header>
<div id="palette"></div>

<div id="wrap">
  <canvas id="canvas"></canvas>
  <div id="ui">Yükleniyor...</div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");

// --- AYARLAR ---
const MAP_SIZE = 2000;
let scale = 10; 
let offsetX = window.innerWidth / 2 - (MAP_SIZE * scale) / 2;
let offsetY = window.innerHeight / 2 - (MAP_SIZE * scale) / 2;
let currentColor = "#ff0000";
let pixels = {};

const colors = ["#ffffff","#000000","#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff","#ffa500","#964b00"];

// --- PALET OLUŞTURMA ---
const palette = document.getElementById("palette");
colors.forEach(c => {
  const d = document.createElement("div");
  d.className = "color";
  d.style.background = c;
  if (c === currentColor) d.classList.add("active");
  d.onclick = () => {
    currentColor = c;
    document.querySelectorAll(".color").forEach(x => x.classList.remove("active"));
    d.classList.add("active");
  };
  palette.appendChild(d);
});

// --- ÇİZİM FONKSİYONU ---
function draw() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);

  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, MAP_SIZE, MAP_SIZE);

  for (const key in pixels) {
    const [px, py] = key.split(",");
    ctx.fillStyle = pixels[key];
    ctx.fillRect(parseInt(px), parseInt(py), 1, 1);
  }

  if (scale > 15) {
    ctx.strokeStyle = "#222";
    ctx.lineWidth = 1 / scale; 
    ctx.beginPath();
    for (let i = 0; i <= MAP_SIZE; i += 5) {
      ctx.moveTo(i, 0); ctx.lineTo(i, MAP_SIZE);
      ctx.moveTo(0, i); ctx.lineTo(MAP_SIZE, i);
    }
    ctx.stroke();
  }
  ctx.restore();
  ui.innerText = `Zoom: ${scale.toFixed(1)}x | X: ${Math.floor(-offsetX/scale)} Y: ${Math.floor(-offsetY/scale)}`;
}

// --- ETKİLEŞİM DEĞİŞKENLERİ ---
let isDragging = false;
let lastPos = { x: 0, y: 0 };
let lastPinchDist = 0;
let isMoving = false; 

// --- FARE OLAYLARI ---
window.addEventListener("mousedown", e => {
  isDragging = true;
  isMoving = false;
  lastPos = { x: e.clientX, y: e.clientY };
});

window.addEventListener("mousemove", e => {
  if (isDragging) {
    isMoving = true;
    offsetX += e.clientX - lastPos.x;
    offsetY += e.clientY - lastPos.y;
    lastPos = { x: e.clientX, y: e.clientY };
    draw();
  }
});

window.addEventListener("mouseup", e => {
  if (!isMoving && e.button === 0) {
    const x = Math.floor((e.clientX - offsetX) / scale);
    const y = Math.floor((e.clientY - offsetY) / scale);
    if (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) placePixel(x, y);
  }
  isDragging = false;
});

// --- DOKUNMATİK (MOBİL) OLAYLARI ---
window.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    lastPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
  } else if (e.touches.length === 1) {
    isDragging = true;
    isMoving = false;
    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
}, { passive: false });

window.addEventListener("touchmove", e => {
  e.preventDefault();
  if (e.touches.length === 2) {
    const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
    const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
    const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
    const worldPos = { x: (midX - offsetX) / scale, y: (midY - offsetY) / scale };
    
    const delta = dist / lastPinchDist;
    scale = Math.min(Math.max(0.5, scale * delta), 60);
    offsetX = midX - worldPos.x * scale;
    offsetY = midY - worldPos.y * scale;
    lastPinchDist = dist;
    draw();
  } else if (e.touches.length === 1 && isDragging) {
    isMoving = true;
    offsetX += e.touches[0].clientX - lastPos.x;
    offsetY += e.touches[0].clientY - lastPos.y;
    lastPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    draw();
  }
}, { passive: false });

window.addEventListener("touchend", e => {
  if (!isMoving && e.changedTouches.length === 1) {
    const t = e.changedTouches[0];
    const x = Math.floor((t.clientX - offsetX) / scale);
    const y = Math.floor((t.clientY - offsetY) / scale);
    if (x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) placePixel(x, y);
  }
  isDragging = false;
});

window.addEventListener("wheel", e => {
  const worldPos = { x: (e.clientX - offsetX) / scale, y: (e.clientY - offsetY) / scale };
  scale = Math.min(Math.max(0.5, scale * (e.deltaY > 0 ? 0.9 : 1.1)), 60);
  offsetX = e.clientX - worldPos.x * scale;
  offsetY = e.clientY - worldPos.y * scale;
  draw();
}, { passive: false });

function placePixel(x, y) {
  pixels[`${x},${y}`] = currentColor;
  draw();
  fetch("/pixel", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ x, y, color: currentColor })
  }).catch(err => console.error("Hata:", err));
}

fetch("/pixels").then(r => r.json()).then(data => {
  pixels = data;
  draw();
});

window.addEventListener("resize", draw);
draw();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Yogito Pixel</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        header { height: 50px; background: #000; display: flex; align-items: center; justify-content: center; gap: 10px; border-bottom: 2px solid #333; }
        #palette { height: 60px; background: #111; display: flex; align-items: center; gap: 10px; padding: 0 15px; overflow-x: auto; }
        .color { width: 35px; height: 35px; border-radius: 8px; border: 2px solid #444; cursor: pointer; flex-shrink: 0; }
        .color.active { border-color: #fff; transform: scale(1.1); }
        
        #canvas-wrap { flex: 1; position: relative; overflow: hidden; background: #333; cursor: crosshair; }
        canvas { background: #fff; image-rendering: pixelated; transform-origin: 0 0; }

        /* BUTONLAR */
        #controls { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: grid; grid-template-columns: repeat(2, 55px); gap: 10px; z-index: 100; }
        .btn { width: 55px; height: 55px; background: #d1d5db; border: 3px solid #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; box-shadow: 4px 4px 0px #000; color: #000; user-select: none; }
        .btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px #000; }
        #btn-pen.active { background: #fef08a; }

        /* CHAT */
        #chat-box { position: absolute; bottom: 20px; left: 15px; width: 250px; height: 200px; background: rgba(0,0,0,0.85); border: 1px solid #444; border-radius: 10px; display: flex; flex-direction: column; z-index: 100; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; color: #ddd; }
        #chat-input-area { display: flex; border-top: 1px solid #444; background: #222; }
        input { flex: 1; background: transparent; border: none; color: #fff; padding: 10px; outline: none; }
        #send { background: #444; border: none; color: #fff; padding: 0 15px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <img src="https://i.imgur.com/WU82uOE.jpeg" style="height:30px; border-radius:5px;">
    <strong>Yogito Pixel</strong>
</header>

<div id="palette"></div>

<div id="canvas-wrap">
    <canvas id="canvas"></canvas>
    
    <div id="controls">
        <div id="btn-pen" class="btn">✎</div>
        <div class="btn" id="btn-zoom-in">+</div>
        <div class="btn" id="btn-up">↑</div>
        <div class="btn" id="btn-zoom-out">−</div>
        <div class="btn" id="btn-left">←</div>
        <div class="btn" id="btn-right">→</div>
        <div class="btn" style="grid-column: span 2;" id="btn-down">↓</div>
    </div>

    <div id="chat-box">
        <div id="messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Mesaj..." maxlength="50">
            <button id="send">></button>
        </div>
    </div>
</div>

<script>
    const socket = io();
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const palette = document.getElementById("palette");
    const btnPen = document.getElementById("btn-pen");

    const MAP_SIZE = 1000;
    const PIXEL_SIZE = 1; // Dahili pixel boyutu
    let scale = 15; // Görünür pixel boyutu
    let offsetX = 0, offsetY = 0;
    let currentColor = "#ff0000";
    let isDrawMode = false;

    // Renkleri oluştur
    const colors = ["#ffffff","#000000","#ff0000","#00ff00","#0000ff","#ffff00","#ff00ff","#00ffff","#ffa500","#964b00"];
    colors.forEach(c => {
        const d = document.createElement("div");
        d.className = "color"; d.style.background = c;
        if (c === currentColor) d.classList.add("active");
        d.onclick = () => {
            currentColor = c;
            document.querySelectorAll(".color").forEach(x => x.classList.remove("active"));
            d.classList.add("active");
        };
        palette.appendChild(d);
    });

    // Çizim Modu
    btnPen.onclick = () => {
        isDrawMode = !isDrawMode;
        btnPen.classList.toggle("active", isDrawMode);
    };

    function drawGrid() {
        canvas.width = MAP_SIZE * scale;
        canvas.height = MAP_SIZE * scale;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Izgara çizimi (Yavaşlamaması için sadece belli bir zoomda çizilir)
        if (scale > 5) {
            ctx.strokeStyle = "#eee";
            ctx.lineWidth = 0.5;
            for(let i=0; i<=MAP_SIZE; i++) {
                ctx.beginPath(); ctx.moveTo(i*scale, 0); ctx.lineTo(i*scale, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i*scale); ctx.lineTo(canvas.width, i*scale); ctx.stroke();
            }
        }
    }

    function renderPixel(x, y, color) {
        ctx.fillStyle = color;
        ctx.fillRect(x * scale, y * scale, scale, scale);
    }

    // Hareket Kontrolleri
    const wrap = document.getElementById("canvas-wrap");
    document.getElementById("btn-up").onclick = () => wrap.scrollTop -= 50;
    document.getElementById("btn-down").onclick = () => wrap.scrollTop += 50;
    document.getElementById("btn-left").onclick = () => wrap.scrollLeft -= 50;
    document.getElementById("btn-right").onclick = () => wrap.scrollLeft += 50;
    document.getElementById("btn-zoom-in").onclick = () => { scale += 2; syncCanvas(); };
    document.getElementById("btn-zoom-out").onclick = () => { if(scale > 2) scale -= 2; syncCanvas(); };

    canvas.onclick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / scale);
        const y = Math.floor((e.clientY - rect.top) / scale);
        
        if (isDrawMode) {
            renderPixel(x, y, currentColor);
            socket.emit('draw-pixel', { x, y, color: currentColor });
        }
    };

    // Socket Olayları
    let localPixels = {};
    function syncCanvas() {
        drawGrid();
        for (let key in localPixels) {
            const [x, y] = key.split(",");
            renderPixel(x, y, localPixels[key]);
        }
    }

    socket.on('init-canvas', (data) => {
        localPixels = data;
        syncCanvas();
    });

    socket.on('update-pixel', (data) => {
        localPixels[`${data.x},${data.y}`] = data.color;
        renderPixel(data.x, data.y, data.color);
    });

    // CHAT MANTIĞI
    const msgInput = document.getElementById("chat-input");
    const msgBox = document.getElementById("messages");
    
    function send() {
        if (msgInput.value.trim()) {
            socket.emit('chat-message', { text: msgInput.value });
            msgInput.value = "";
        }
    }
    document.getElementById("send").onclick = send;
    msgInput.onkeydown = (e) => { if(e.key === "Enter") send(); };

    socket.on('chat-message', (data) => {
        const div = document.createElement("div");
        div.style.marginBottom = "5px";
        div.innerHTML = `<b style="color:#fef08a">${data.user}:</b> ${data.text}`;
        msgBox.appendChild(div);
        msgBox.scrollTop = msgBox.scrollHeight;
    });

    socket.on('init-chat', (history) => {
        msgBox.innerHTML = "";
        history.forEach(m => {
            const div = document.createElement("div");
            div.innerHTML = `<b style="color:#fef08a">${m.user}:</b> ${m.text}`;
            msgBox.appendChild(div);
        });
        msgBox.scrollTop = msgBox.scrollHeight;
    });

    window.onload = syncCanvas;
</script>
</body>
</html>
